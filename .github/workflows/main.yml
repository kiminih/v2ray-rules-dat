name: Sync and Modify Direct List

on:
  schedule:
    - cron: '0 * * * *'  # 每小时检查一次
  workflow_dispatch:  # 手动触发
  watch:
    types: [started]  # 监听上游仓库的更新

jobs:
  sync-and-modify:
    runs-on: ubuntu-latest

    steps:
    # Checkout Fork 仓库
    - name: Checkout Fork Repository
      uses: actions/checkout@v2
      with:
        persist-credentials: false
        fetch-depth: 0  # 获取完整历史记录以支持分支同步

    # Fetch 上游仓库
    - name: Fetch Upstream Repository
      run: |
        git remote add upstream https://github.com/Loyalsoldier/v2ray-rules-dat.git
        git fetch upstream
        git checkout main
        git merge upstream/release  # 合并上游分支

    # 使用 sed 命令去掉 'alibaba-inc.com' 行
    - name: Remove alibaba-inc.com from direct-list.txt
      run: |
        sed -i '/^alibaba-inc\.com$/d' release/direct-list.txt

    # 提交修改并推送到 Fork 项目
    - name: Commit changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add release/direct-list.txt
        git commit -m "Remove alibaba-inc.com from direct-list.txt"
        git push origin main
